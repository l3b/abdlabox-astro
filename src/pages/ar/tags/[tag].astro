
---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { findTagByValue, normalizeTag, tags } from '../../../data/tags';

export async function getStaticPaths() {
  const allTags = Object.values(tags);
  return allTags.map(tagTranslation => ({
    params: { tag: tagTranslation.slug.ar },
    props: { tag: tagTranslation.slug.ar }
  }));
}

const { tag } = Astro.props;
const tagTranslation = findTagByValue(tag);

if (!tagTranslation) {
  return Astro.redirect('/ar/blog');
}

const posts = await getCollection('blog', ({ data }) => {
  return data.language === 'ar' && !data.isDraft && 
         (data.tags || []).some(t => {
           const foundTag = findTagByValue(t);
           return foundTag && (foundTag.ar === tagTranslation.ar);
         });
});

const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title={`المواضيع في "${tag}"`} description={`جميع المواضيع في ${tag}`} lang="ar" dir="rtl">
  <div class="container mx-auto px-4 py-8 md:px-6 md:py-12">
    <div class="inline-block">
      <h1 class="text-4xl md:text-5xl font-bold mb-2 text-soft-charcoal">
        {tag}
      </h1>
      <div class="h-1 bg-neon-yellow"></div>
    </div>
    <p class="text-lg text-gray-600 mb-8">
      تصفح جميع المقالات تحت تصنيف {tag}
    </p>

    <div class="space-y-6">
      {sortedPosts.map(post => (
        <article class="border-r-4 border-neon-yellow pr-4">
          <a href={`/ar/blog/${post.slug.replace(/^ar\//, '')}`} class="no-underline">
            <h2 class="text-xl font-semibold text-electric-blue hover:text-teal-600">
              {post.data.title}
            </h2>
          </a>
          {post.data.description && (
            <p class="text-gray-600 mt-2">{post.data.description}</p>
          )}
        </article>
      ))}
    </div>
  </div>
</BaseLayout>
