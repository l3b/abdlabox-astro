---
// src/pages/en/blog/[slug].astro - Code Block Readability Fix
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getBlogTranslation } from '../../../utils/i18n';
import { generateBlogPostSchema } from '../../../utils/structuredData';
import OptimizedImage from '../../../components/OptimizedImage.astro';

export async function getStaticPaths() {
  const allEnglishPosts = await getCollection('blog', ({ data }) => {
    return data.language === 'en' && data.isDraft !== true;
  });
  return allEnglishPosts.map(post => ({
    params: { slug: post.slug.replace(/^en\//, '') },
    props: { post },
  }));
}

type Props = { post: CollectionEntry<'blog'> };
const { post } = Astro.props;
const { Content } = await post.render();
const translatedPost = await getBlogTranslation(post);

const pageTitle = post.data.title;
const pageDescription = post.data.description;

// Generate structured data for blog post
const blogPostSchema = generateBlogPostSchema(
  post.data.title,
  post.data.description,
  post.data.pubDate,
  post.data.updatedDate,
  post.slug.replace(/^en\//, ''),
  post.data.featuredImage?.url
);

// Assuming the existence of a tags object mapping tags to slugs.  This needs to be defined elsewhere.
import { tags } from '../../../data/tags';

// Use the readingTime utility
import { getReadingTime } from '../../../utils/readingTime';
const readingTime = getReadingTime(post.body);


// Added to get previous and next posts.  This requires additional logic to determine order.
const allPosts = await getCollection('blog', ({ data }) => data.language === 'en' && data.isDraft !== true);
const currentIndex = allPosts.findIndex(p => p.slug === post.slug);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;

---
<BaseLayout title={pageTitle} description={pageDescription} lang="en" dir="ltr">
  <!-- JSON-LD Structured Data for Blog Post -->
  <script type="application/ld+json" set:html={JSON.stringify(blogPostSchema)}></script>

  <div class="container mx-auto px-4 py-8 md:px-6 md:py-12">
    <article>
      {/* Post Header Section */}
      <header class="mb-8 border-b border-gray-300 pb-6">
        <h1 class="inline-block text-3xl md:text-4xl font-bold mb-3 text-soft-charcoal pb-2 border-b-2 border-b-neon-yellow">
          {post.data.title}
        </h1>
        <div class="text-sm text-gray-600 flex flex-wrap items-center gap-x-4 gap-y-2 mt-3">
          <span>
            Published on: {post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </span>
          {post.data.tags && post.data.tags.length > 0 && (
            <span class="flex items-center gap-x-1.5 flex-wrap">
              Tags:
              {post.data.tags.map(tag => {
                const normalizedTag = tag.toLowerCase().replace(/\s+/g, '-');
                const tagConfig = Object.entries(tags).find(([_, t]) => 
                  t.slug.en === normalizedTag || t.slug.ar === normalizedTag
                );
                return tagConfig && (
                  <a href={`/en/tags/${tagConfig[1].slug.en}`} class="tag">
                    {tagConfig[1].en}
                  </a>
                );
              })}
            </span>
          )}
          <div class="text-sm text-gray-600 mt-2">
            {readingTime} min read
          </div>
        </div>
        {post.data.featuredImage && (
          <figure class="mt-6">
            {post.data.featuredImage.r2Path ? (
              <OptimizedImage 
                src={`r2://${post.data.featuredImage.r2Path}`}
                alt={post.data.featuredImage.alt}
                width={800}
                height={400}
                class="w-full h-auto rounded-lg shadow-lg"
              />
            ) : (
              <img 
                src={post.data.featuredImage.url} 
                alt={post.data.featuredImage.alt}
                class="w-full h-auto rounded-lg shadow-lg"
              />
            )}
            {post.data.featuredImage.caption && (
              <figcaption class="text-center text-gray-600 mt-2 text-sm">
                {post.data.featuredImage.caption}
              </figcaption>
            )}
          </figure>
        )}
      </header>

      <nav class="flex justify-between mb-8 text-sm">
        {prevPost && (
          <a href={`/en/blog/${prevPost.slug.replace(/^en\//, '')}`} class="text-teal-600 hover:text-lavender">
            ← {prevPost.data.title}
          </a>
        )}
        {nextPost && (
          <a href={`/en/blog/${nextPost.slug.replace(/^en\//, '')}`} class="text-teal-600 hover:text-lavender ml-auto">
            {nextPost.data.title} →
          </a>
        )}
      </nav>

      {/* Main Post Content - Apply 'prose' classes here */}
      <div
        class="
          prose prose-lg max-w-none mt-8
          prose-headings:font-semibold prose-headings:text-soft-charcoal
          prose-p:text-soft-charcoal !prose-p:text-soft-charcoal prose-p:leading-relaxed
          prose-a:text-teal-600 prose-a:underline hover:prose-a:text-lavender
          prose-strong:text-soft-charcoal prose-strong:font-semibold
          prose-blockquote:border-l-electric-blue prose-blockquote:pl-4 prose-blockquote:italic
          prose-li:marker:text-electric-blue
          prose-pre:bg-soft-charcoal prose-pre:text-gray-200 prose-pre:p-4 prose-pre:rounded-lg prose-pre:overflow-x-auto
          /* Removed prose-code:* utilities to avoid conflict with global CSS override */
          dark:prose-invert dark:prose-headings:text-cool-light-gray dark:prose-p:text-gray-300 dark:prose-strong:text-cool-light-gray dark:prose-a:text-teal dark:hover:prose-a:text-lavender dark:prose-blockquote:border-l-teal dark:prose-li:marker:text-teal dark:prose-pre:bg-gray-800/80 dark:prose-pre:text-gray-200
        "
      >
        <Content />
      </div>

    </article>
  </div>
</BaseLayout>