---
// src/pages/en/index.astro - English Homepage v15 (With Strava API Integration)
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Icon } from 'astro-icon/components';
import { BskyAgent, type ComAtprotoLabelDefs } from '@atproto/api';
import OptimizedImage from '../../components/OptimizedImage.astro';
import StravaStats from '../../components/StravaStats.astro';
import EmptyState from '../../components/EmptyState.astro';
import Footer from '../../components/Footer.astro';
import { formatDistanceToNow } from 'date-fns'; // For relative time
import { enUS } from 'date-fns/locale'; // For English relative time

const pageTitle = "The Base"; // English Title
const pageSubtitle = "A live snapshot from my digital world"; // English Subtitle
const pageDescription = "Abdullah's digital interface: Exploring ideas and experiences across various signals."; // English Description

// --- Fetch Latest ENGLISH Blog Posts (up to 3) ---
let latestEnPosts = [];
try {
    latestEnPosts = (await getCollection('blog', ({ data, slug }) => {
        // Filter for English posts now
        return slug.startsWith('en/') && data.isDraft !== true;
    })).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()).slice(0, 3);
    console.log("Found Latest English Blog Post:", latestEnPosts[0]?.data.title);
} catch (e) { console.error("Error fetching English blog posts:", e); }


// --- Fetch Goodreads Currently Reading (Logic is language-agnostic) ---
interface ReadingBook { title: string; link: string; }
let currentlyReadingBooks: ReadingBook[] = [];
const GOODREADS_RSS_URL = "https://www.goodreads.com/review/list_rss/4693662?shelf=currently-reading";
const GOODREADS_PROFILE_URL = "https://www.goodreads.com/user/show/4693662-abdullah-althani";
try {
  const response = await fetch(GOODREADS_RSS_URL);
  if (response.ok) {
    const xmlText = await response.text();
    const itemMatches = xmlText.matchAll(/<item>(.*?)<\/item>/gs);
    for (const match of itemMatches) {
      const itemContent = match[1];
      const titleMatch = itemContent.match(/<title>(?:<!\[CDATA\[)?(.*?)(?:\]\]>)?<\/title>/s);
      const linkMatch = itemContent.match(/<link>(.*?)<\/link>/s);
      const title = titleMatch ? titleMatch[1].trim() : null;
      let link: string | null = null;
      if (linkMatch && linkMatch[1]) {
        link = linkMatch[1].replace('<![CDATA[', '').replace(']]>', '').trim();
      }
      if (title && link) {
        currentlyReadingBooks.push({ title, link });
      }
      if (currentlyReadingBooks.length >= 3) break; // Limit to 3 books
    }
  } else {
    console.error(`Goodreads RSS fetch failed: ${response.status}`);
  }
} catch (error) {
  console.error("Error fetching Goodreads:", error);
}


// --- Fetch Trakt Recently Watched (Logic is language-agnostic) ---
interface WatchedItem { id: number; title: string; link: string; type: 'movie' | 'episode' | 'unknown'; overview: string | null; }
let recentlyWatchedItems: WatchedItem[] = [];
const TRAKT_USERNAME = 'althani';
const TRAKT_API_KEY = import.meta.env.TRAKT_API_KEY;
const TRAKT_PROFILE_URL = `https://trakt.tv/users/${TRAKT_USERNAME}`;
if (TRAKT_API_KEY) { try {
    const traktUrl = `https://api.trakt.tv/users/${TRAKT_USERNAME}/history?limit=3&extended=full`;
    // console.log(`Workspaceing Trakt History: ${traktUrl}`); // Optional: uncomment for debugging
    const traktResponse = await fetch(traktUrl, { headers: { 'Content-Type': 'application/json', 'trakt-api-version': '2', 'trakt-api-key': TRAKT_API_KEY }});
    if (traktResponse.ok) {
       const historyData = await traktResponse.json();
       if (historyData && historyData.length > 0) {
          recentlyWatchedItems = historyData.map((item: any): WatchedItem | null => {
             let title = '', link = '#', overview: string | null = null; const type = item.type || 'unknown'; const id = item.id;
             try {
               if (type === 'movie' && item.movie?.ids?.slug) { title = item.movie.title || 'Unknown Movie'; link = `https://trakt.tv/movies/${item.movie.ids.slug}`; overview = item.movie.overview; }
               else if (type === 'episode' && item.show?.ids?.slug && item.episode) { const showTitle = item.show.title || 'Unknown Show'; const season = item.episode.season; const number = item.episode.number; const epTitle = item.episode.title ? ` - ${item.episode.title}` : ''; title = `${showTitle} S${String(season).padStart(2, '0')}E${String(number).padStart(2, '0')}${epTitle}`; link = `https://trakt.tv/shows/${item.show.ids.slug}/seasons/${season}/episodes/${number}`; overview = item.episode.overview || item.show.overview; }
             } catch (e) { return null; }
             if (title && id) { return { id, title, link, type, overview }; } return null;
          }).filter((item): item is WatchedItem => item !== null);
       } // else { console.log("No items found in Trakt history."); }
    } else { console.error(`Trakt fetch failed: ${traktResponse.status}`); }
 } catch (error) { console.error("Error fetching Trakt:", error); }
} else { console.warn("TRAKT_API_KEY not set in .env"); }

// --- Fetch Latest Bluesky Posts (English) ---
interface BlueskyPost { text: string | null; uri: string; cid: string; embedImageUrl?: string; embedLinkUrl?: string; embedLinkTitle?: string; replyParent?: string; reason?: string; labels?: ComAtprotoLabelDefs.Label[]; }
let latestBlueskyPosts: BlueskyPost[] = [];
const BSKY_IDENTIFIER = import.meta.env.BLUESKY_IDENTIFIER;
const BSKY_APP_PASSWORD = import.meta.env.BLUESKY_APP_PASSWORD;
const TARGET_LANG_EN = 'en'; // Target English posts

if (BSKY_IDENTIFIER && BSKY_APP_PASSWORD) { try {
    const agent = new BskyAgent({ service: 'https://bsky.social' });
    await agent.login({ identifier: BSKY_IDENTIFIER, password: BSKY_APP_PASSWORD });
    const response = await agent.app.bsky.feed.getAuthorFeed({ actor: BSKY_IDENTIFIER, limit: 20 });

    if (response.success && response.data.feed.length > 0) {
      latestBlueskyPosts = response.data.feed
        .map((feedItem): BlueskyPost | null => {
            const post = feedItem.post; const reason = feedItem.reason;
            if (!post?.record || !post.uri || !post.cid) return null;
            const langs = post.record.langs as string[] | undefined;
            // FILTER FOR ENGLISH
            if (!langs || !langs.includes(TARGET_LANG_EN)) return null;
            const labels = post.labels as ComAtprotoLabelDefs.Label[] | undefined;
            const hazardousLabels = ['porn', 'sexual', 'nudity'];
            if (labels?.some(label => hazardousLabels.includes(label.val))) return null;
            let embedImageUrl: string | undefined = undefined; let embedLinkUrl: string | undefined = undefined; let embedLinkTitle: string | undefined = undefined;
            if (post.embed?.images && post.embed.$type === 'app.bsky.embed.images#view') { embedImageUrl = post.embed.images[0]?.thumb; }
            else if (post.embed?.external && post.embed.$type === 'app.bsky.embed.external#view') { embedImageUrl = post.embed.external.thumb; embedLinkUrl = post.embed.external.uri; embedLinkTitle = post.embed.external.title;}
            const replyParent = post.record.reply?.parent?.uri;
            return { text: typeof post.record.text === 'string' ? post.record.text : null, uri: post.uri, cid: post.cid, embedImageUrl: embedImageUrl, embedLinkUrl: embedLinkUrl, embedLinkTitle: embedLinkTitle, replyParent: replyParent, reason: reason?.$type };
        })
        .filter((item): item is BlueskyPost => item !== null)
        .filter(item => item.reason !== 'app.bsky.feed.defs#reasonRepost' || item.text)
        .slice(0, 3);
    }
  } catch (error) { console.error("Error fetching Bluesky:", error); }
} else { console.warn("Bluesky credentials not set"); }

// --- Fetch Latest GitHub Events ---
interface GitHubEvent { id: string; display: string; link: string; timeAgo: string; }
let latestGitHubEvents: GitHubEvent[] = [];
const GITHUB_USERNAME = 'l3b';
const GITHUB_PROFILE_URL = `https://github.com/${GITHUB_USERNAME}`;
try {
  const githubUrl = `https://api.github.com/users/${GITHUB_USERNAME}/events/public?per_page=5`;
  const githubResponse = await fetch(githubUrl, { headers: { Accept: 'application/vnd.github.v3+json' } });
  if (githubResponse.ok) {
    const events = await githubResponse.json();
    if (events && events.length > 0) {
      latestGitHubEvents = events
        .map((event: any): GitHubEvent | null => {
          let display = 'performed some activity'; // Default English
          let link = GITHUB_PROFILE_URL;
          let timeAgo = '';
          if (event.created_at) { try { timeAgo = formatDistanceToNow(new Date(event.created_at), { addSuffix: true, locale: enUS }); } catch (e) {} } // Use enUS locale
          const repoName = event.repo?.name;
          const repoUrl = repoName ? `https://github.com/${repoName}` : GITHUB_PROFILE_URL;

          switch (event.type) { // Translate display strings
            case 'PushEvent':
              const commitCount = event.payload?.commits?.length || 0;
              if (commitCount > 0) {
                  const commitMsg = event.payload?.commits?.[0]?.message?.split('\n')[0] || 'update';
                  display = `Pushed ${commitCount} ${commitCount === 1 ? 'commit' : 'commits'} to ${repoName}: "${commitMsg}"`;
                  link = commitCount === 1 && event.payload?.commits?.[0]?.sha ? `https://github.com/${repoName}/commit/${event.payload.commits[0].sha}` : repoUrl;
              } else { display = `Pushed to ${repoName}`; link = repoUrl; }
              break;
            case 'CreateEvent':
              const refType = event.payload?.ref_type;
              if (refType === 'repository') { display = `Created repository ${repoName}`; link = repoUrl; }
              else if (refType === 'branch' && event.payload.ref) { display = `Created branch ${event.payload.ref} in ${repoName}`; link = `https://github.com/${repoName}/tree/${event.payload.ref}`; }
              else { display = `Created ${refType || 'something'} in ${repoName}`; link = repoUrl; }
              break;
            case 'WatchEvent':
              if (event.payload?.action === 'started') { display = `Starred ${repoName}`; link = repoUrl; }
              else return null;
              break;
            case 'ForkEvent':
               display = `Forked ${repoName}`;
               link = event.payload?.forkee?.html_url || repoUrl;
               break;
            case 'PublicEvent':
               display = `Made ${repoName} public`;
               link = repoUrl;
               break;
            default: // Generic English default
              display = `Performed ${event.type.replace('Event','')} in ${repoName || 'GitHub'}`;
              link = repoUrl || GITHUB_PROFILE_URL;
              console.log(`Using generic display for GitHub event type: ${event.type}`);
          }
          return { id: event.id, display, link, timeAgo };
        })
        .filter((item): item is GitHubEvent => item !== null)
        .slice(0, 3);
    }
  } else { console.error(`GitHub API fetch failed: ${githubResponse.status}`); }
} catch (error) { console.error("Error fetching GitHub events:", error); }
---

{/* Use English lang/dir props */}
<BaseLayout title={pageTitle} description={pageDescription} lang="en" dir="ltr">
  <div class="container mx-auto px-4 py-12 md:px-6 md:py-16">

    {/* Page Title & Subtitle */}
    <h1 class="text-4xl md:text-5xl font-bold text-center mb-2 text-soft-charcoal">{pageTitle}</h1>
    <p class="text-lg text-gray-600 text-center mb-12 md:mb-16">{pageSubtitle}</p>

    {/* Dynamic Grid Layout with Different Card Sizes */}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6 md:gap-8 auto-rows-min">

      {/* Section 1: Latest Blog Posts - Large Card */}
      <section class="card card-accent-blog md:col-span-2 lg:col-span-8 lg:row-span-2">
        <a href="/en/blog" class="block">
          <h2 class="text-2xl font-bold text-electric-blue mb-4 flex items-center gap-2 flex-shrink-0 hover:text-teal transition-colors">
            <Icon name="mdi:post-outline" class="w-7 h-7 flex-shrink-0"/>
            Latest from the Blog
          </h2>
        </a>
        <div class="flex-grow space-y-4">
          {latestEnPosts.map(post => (
            <div class="space-y-2">
              {post.data.featuredImage && (
                <a href={`/en/blog/${post.slug.replace(/^en\//, '')}`} class="block mb-4">
                  {post.data.featuredImage.r2Path ? (
                    <OptimizedImage 
                      src={`r2://${post.data.featuredImage.r2Path}`}
                      alt={post.data.featuredImage.alt || `Featured image for ${post.data.title}`}
                      width={300}
                      height={128}
                      class="w-full h-32 object-cover rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
                    />
                  ) : (
                    <img 
                      src={post.data.featuredImage.url} 
                      alt={post.data.featuredImage.alt || `Featured image for ${post.data.title}`} 
                      class="w-full h-32 object-cover rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
                    />
                  )}
                </a>
              )}
              <h3 class="text-lg font-semibold">
                <a href={`/en/blog/${post.slug.replace(/^en\//, '')}`}
                   class="hover:text-teal-600 transition-colors duration-200">
                  <span class="text-soft-charcoal">
                    {post.data.title}
                  </span>
                </a>
              </h3>
              {post.data.description && (
                <p class="text-gray-600 text-sm leading-relaxed line-clamp-2">
                  {post.data.description}
                </p>
              )}
            </div>
          ))}
        </div>
        ) : (
          <EmptyState 
            message="No recent posts available"
            icon="mdi:post-outline"
            locale="en"
          />
        )}
        <a href="/en/blog" class="text-teal-600 hover:text-lavender font-medium inline-flex items-center gap-1 text-sm mt-6 flex-shrink-0">
          All Posts <span aria-hidden="true">&rarr;</span>
        </a>
      </section>

      {/* Section 2: Goodreads Currently Reading */}
       <section class="card">
         <h2 class="text-xl font-semibold text-electric-blue mb-4 flex items-center gap-2 flex-shrink-0">
           <Icon name="simple-icons:strava" class="w-6 h-6 flex-shrink-0"/>
           Latest Running Activities
         </h2>
         <div class="flex-grow">
           <StravaStats locale="en" />
         </div>
       </section>

      {/* Section 3: Trakt Recently Watched */}
       <section class="card">
        <a href={TRAKT_PROFILE_URL} target="_blank" rel="noopener noreferrer" class="text-electric-blue">
          <h2 class="text-xl font-semibold text-electric-blue mb-4 flex items-center gap-2 flex-shrink-0">
              <Icon name="simple-icons:trakt" class="w-6 h-6 flex-shrink-0"/>
              Recently Watched
          </h2>
        </a>
         {recentlyWatchedItems.length > 0 ? (
            <div class="flex-grow">
              <ul class="space-y-4">
                {recentlyWatchedItems.map(item => (
                  <li key={item.id}>
                    <a href={item.link} target="_blank" rel="noopener noreferrer" class="hover:text-teal-600 transition-colors duration-200 block group">
                       <p class="text-soft-charcoal text-base font-medium leading-snug group-hover:text-teal-600">
                          {item.type === 'movie' ? 'ðŸŽ¬ ' : 'ðŸ“º '}
                          {item.title}
                       </p>
                    </a>
                     {item.overview && (
                       <p class="text-xs text-gray-500 leading-normal mt-1 line-clamp-2">
                         {item.overview}
                       </p>
                     )}
                  </li>
                ))}
              </ul>
            </div>
         ) : ( <p class="italic text-gray-400 flex-grow">(No recent watched history found or failed to fetch...)</p> )} {/* English Fallback */}
           <a href={TRAKT_PROFILE_URL} target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 hover:text-lavender mt-4 flex-shrink-0 self-start">
              My Trakt Profile &rarr; {/* English Link Text */}
           </a>
       </section>

       {/* Section 4: GitHub Latest Events - Compact Card */}
       <section class="card card-compact card-accent-code md:col-span-1 lg:col-span-6">
         <h2 class="text-lg font-semibold text-electric-blue mb-3 flex items-center gap-2 flex-shrink-0">
           <Icon name="simple-icons:github" class="w-5 h-5 flex-shrink-0"/>
           From GitHub
         </h2>
         <div class="flex-grow">
           {latestGitHubEvents.length > 0 ? (
              <ul class="space-y-2">
                {latestGitHubEvents.map(event => (
                  <li key={event.id}>
                    <a href={event.link} target="_blank" rel="noopener noreferrer" class="hover:text-teal-600 transition-colors duration-200 group">
                       <p class="text-soft-charcoal text-sm leading-relaxed group-hover:text-teal-600">
                          {event.display}
                       </p>
                    </a>
                    <p class="text-xs text-gray-500 mt-1">{event.timeAgo}</p>
                  </li>
                ))}
              </ul>
           ) : (
              <EmptyState 
                message="No recent activity"
                icon="simple-icons:github"
                locale="en"
              />
           )}
         </div>
         <a href={GITHUB_PROFILE_URL} target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 hover:text-lavender mt-3 flex-shrink-0 self-start">
            My GitHub Profile &rarr;
         </a>
       </section>

       {/* Section 5: Goodreads Currently Reading - Compact Card */}
       <section class="card card-compact card-accent-reading md:col-span-1 lg:col-span-4">
         <h2 class="text-lg font-semibold text-electric-blue mb-3 flex items-center gap-2 flex-shrink-0">
           <Icon name="simple-icons:goodreads" class="w-5 h-5 flex-shrink-0"/>
           Currently Reading
         </h2>
         <div class="flex-grow">
           {currentlyReadingBooks.length > 0 ? (
              <div class="space-y-2">
                {currentlyReadingBooks.map(book => (
                  <a href={book.link} target="_blank" rel="noopener noreferrer" class="hover:text-teal-600 transition-colors duration-200 block">
                     <p class="text-soft-charcoal text-sm font-medium leading-snug">
                        {book.title}
                     </p>
                  </a>
                ))}
              </div>
           ) : (
              <EmptyState 
                message="No books currently"
                icon="simple-icons:goodreads"
                locale="en"
              />
           )}
         </div>
         <a href={GOODREADS_PROFILE_URL} target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 hover:text-lavender mt-3 flex-shrink-0 self-start">
            My Goodreads Profile &rarr;
         </a>
       </section>

       {/* Section 6: Trakt Recently Watched - Compact Card */}
       <section class="card card-compact card-accent-coral md:col-span-1 lg:col-span-4">
         <a href="https://trakt.tv/users/althani" target="_blank" rel="noopener noreferrer" class="block">
           <h2 class="text-lg font-semibold text-electric-blue mb-3 flex items-center gap-2 flex-shrink-0 hover:text-teal transition-colors">
             <Icon name="simple-icons:trakt" class="w-5 h-5 flex-shrink-0"/>
             Recently Watched
           </h2>
         </a>
         {recentlyWatchedItems.length > 0 ? (
            <div class="flex-grow">
              <ul class="space-y-2">
                {recentlyWatchedItems.map(item => (
                  <li key={item.id}>
                    <a href={item.link} target="_blank" rel="noopener noreferrer" class="hover:text-teal-600 transition-colors duration-200 block group">
                       <p class="text-soft-charcoal text-sm font-medium leading-snug group-hover:text-teal-600">
                          {item.type === 'movie' ? 'ðŸŽ¬ ' : 'ðŸ“º '}
                          {item.title}
                       </p>
                    </a>
                     {item.overview && (
                       <p class="text-xs text-gray-500 leading-normal mt-1 line-clamp-1">
                         {item.overview}
                       </p>
                     )}
                  </li>
                ))}
              </ul>
            </div>
         ) : (
            <EmptyState 
              message="No recent watched history"
              icon="simple-icons:trakt"
              locale="en"
            />
         )}
         <a href={TRAKT_PROFILE_URL} target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 hover:text-lavender mt-3 flex-shrink-0 self-start">
            My Trakt Profile &rarr;
         </a>
       </section>


    </div> {/* End Grid */}
  </div> {/* End Container */}
  <Footer />
</BaseLayout>