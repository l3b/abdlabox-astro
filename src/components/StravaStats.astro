---
// Strava Stats Component
import { fetchStravaStats } from '../utils/stravaApi';
import { Icon } from 'astro-icon/components';

const stats = await fetchStravaStats();
const locale = Astro.currentLocale || 'ar';

// Format distance for display
const formatDistance = (distance: number) => {
  return locale === 'ar' ? `${distance} كم` : `${distance} km`;
};

// Annual goal constant
const ANNUAL_GOAL = 750; // km
---

{stats ? (
  <div class="space-y-4">
    {/* Annual Progress - Main Feature */}
    <div class="bg-gradient-to-br from-electric-blue/5 to-teal/5 dark:from-electric-blue/10 dark:to-teal/10 rounded-lg p-4 border border-electric-blue/20 dark:border-electric-blue/30">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">
          {locale === 'ar' ? 'هدف السنة' : 'Annual Goal'}
        </h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">
          {locale === 'ar' ? `${stats.thisYear.runs} جريات` : `${stats.thisYear.runs} runs`}
        </span>
      </div>
      
      <div class="mb-3">
        <div class="flex items-baseline gap-2">
          <span class="text-2xl font-bold text-electric-blue dark:text-electric-blue-light">
            {formatDistance(stats.thisYear.distance)}
          </span>
          <span class="text-sm text-gray-500 dark:text-gray-400">
            {locale === 'ar' ? `من ${ANNUAL_GOAL} كم` : `of ${ANNUAL_GOAL} km`}
          </span>
        </div>
      </div>
      
      {/* Annual Progress Bar */}
      <div class="relative">
        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div 
            class="h-full bg-gradient-to-r from-electric-blue to-teal dark:from-electric-blue-light dark:to-teal rounded-full transition-all duration-500"
            style={`width: ${stats.thisYear.progress}%`}
          />
        </div>
        <div class="flex justify-between items-center mt-1">
          <span class="text-xs text-gray-500 dark:text-gray-400">
            {locale === 'ar' ? `${stats.thisYear.progress}% مكتمل` : `${stats.thisYear.progress}% complete`}
          </span>
          <span class="text-xs text-gray-500 dark:text-gray-400">
            {locale === 'ar' ? `باقي ${Math.round((ANNUAL_GOAL - stats.thisYear.distance) * 10) / 10} كم` : `${Math.round((ANNUAL_GOAL - stats.thisYear.distance) * 10) / 10} km to go`}
          </span>
        </div>
      </div>
    </div>

    {/* Week & Month Stats */}
    <div class="grid grid-cols-2 gap-3">
      <div class="bg-white/50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
        <h4 class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
          {locale === 'ar' ? 'هذا الأسبوع' : 'This Week'}
        </h4>
        <p class="text-lg font-bold text-soft-charcoal dark:text-gray-200">
          {formatDistance(stats.thisWeek.distance)}
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          {locale === 'ar' ? `${stats.thisWeek.runs} جريات • ${stats.thisWeek.time} دقيقة` : `${stats.thisWeek.runs} runs • ${stats.thisWeek.time} min`}
        </p>
      </div>
      
      <div class="bg-white/50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
        <h4 class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">
          {locale === 'ar' ? 'هذا الشهر' : 'This Month'}
        </h4>
        <p class="text-lg font-bold text-soft-charcoal dark:text-gray-200">
          {formatDistance(stats.thisMonth.distance)}
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          {locale === 'ar' ? `${stats.thisMonth.runs} جريات` : `${stats.thisMonth.runs} runs`}
        </p>
      </div>
    </div>

    {/* Recent Activities */}
    {stats.recentActivities && stats.recentActivities.length > 0 && (
      <div class="space-y-2">
        <h4 class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">
          {locale === 'ar' ? 'آخر 3 نشاطات' : 'Last 3 Activities'}
        </h4>
        {stats.recentActivities.map((activity) => (
          <a
            href={`https://www.strava.com/activities/${activity.id}`}
            target="_blank"
            rel="noopener noreferrer"
            key={activity.id}
            class="flex items-center justify-between py-2 px-3 bg-white/30 dark:bg-gray-800/30 rounded-md hover:bg-white/50 dark:hover:bg-gray-800/50 transition-colors group block"
          >
            <div class="flex-1">
              <p class="text-sm font-medium text-soft-charcoal dark:text-gray-200 group-hover:text-electric-blue dark:group-hover:text-electric-blue-light truncate">
                {activity.name}
              </p>
              <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                <span>{formatDistance(activity.distance)}</span>
                <span>{activity.time}</span>
                <span class="flex items-center gap-1">
                  <Icon name="mdi:speedometer" class="w-3 h-3" />
                  {activity.pace}/km
                </span>
              </div>
            </div>
            <div class="flex flex-col items-end">
              <span class="text-xs text-gray-400 dark:text-gray-500">
                {activity.date}
              </span>
              <Icon name="mdi:open-in-new" class="w-3 h-3 text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity mt-1" />
            </div>
          </a>
        ))}
      </div>
    )}

    {/* Strava Profile Link */}
    <a 
      href="https://www.strava.com/athletes/7746516" 
      target="_blank" 
      rel="noopener noreferrer" 
      class="text-xs text-gray-500 dark:text-gray-400 hover:text-lavender dark:hover:text-lavender inline-flex items-center gap-1"
    >
      {locale === 'ar' ? 'ملفي على Strava' : 'My Strava Profile'} 
      <span aria-hidden="true">←</span>
    </a>
  </div>
) : (
  <div class="space-y-3">
    {/* Skeleton loader while data loads */}
    <div class="animate-pulse">
      <div class="h-24 bg-gray-200 dark:bg-gray-700 rounded-lg mb-3"></div>
      <div class="grid grid-cols-2 gap-3">
        <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded-lg"></div>
        <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded-lg"></div>
      </div>
    </div>
    <p class="text-xs text-gray-400 dark:text-gray-500 italic">
      {locale === 'ar' ? 'جاري تحميل البيانات...' : 'Loading data...'}
    </p>
  </div>
)}